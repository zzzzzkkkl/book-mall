<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>注册 - 在线图书销售系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <style>
        .register-container {
            max-width: 450px;
            margin: 60px auto;
            padding: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        .register-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .register-header h3 {
            color: #198754;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .register-header p {
            color: #6c757d;
            font-size: 0.95em;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 6px;
        }
        .form-control:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
        }
        .btn-register {
            background: linear-gradient(135deg, #198754 0%, #157347 100%);
            border: none;
            font-weight: 500;
            padding: 12px;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .btn-register:hover {
            background: linear-gradient(135deg, #157347 0%, #146c43 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
        }
        .btn-register:active {
            transform: translateY(0);
        }
        .login-link {
            text-align: center;
            margin-top: 25px;
            color: #6c757d;
        }
        .login-link a {
            color: #0d6efd;
            text-decoration: none;
            font-weight: 500;
        }
        .login-link a:hover {
            text-decoration: underline;
        }
        .error-msg {
            font-size: 0.85em;
            padding: 6px 10px;
            border-radius: 4px;
            margin-top: 4px;
            display: none;
        }
        .password-hint {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 4px;
        }
        .field-required {
            color: #dc3545;
        }
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .input-group {
            position: relative;
            margin-bottom: 5px;
        }
        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 3;
        }
        .input-with-icon {
            padding-left: 40px;
        }
        .strength-meter {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        .strength-weak { background: #dc3545; }
        .strength-medium { background: #ffc107; }
        .strength-strong { background: #198754; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="index.html">在线图书销售系统</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                <li class="nav-item"><a class="nav-link" href="login.html">登录</a></li>
                <li class="nav-item"><a class="nav-link active" href="register.html">注册</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="register-container">
    <div class="register-header">
        <h3>用户注册</h3>
        <p>创建新账号，开启图书购物之旅</p>
    </div>

    <form id="registerForm">
        <div class="form-group mb-4">
            <label for="loginName" class="form-label">
                登录账号 <span class="field-required">*</span>
            </label>
            <div class="input-group">
                <span class="input-icon">
                    <i class="bi bi-person"></i>
                </span>
                <input type="text" class="form-control input-with-icon" id="loginName" name="loginName"
                       placeholder="请输入2-16位账号" required>
            </div>
            <div class="text-danger error-msg" id="loginNameError"></div>
            <div class="password-hint">用户名应包含字母、数字或下划线</div>
        </div>

        <div class="form-group mb-4">
            <label for="password" class="form-label">
                密码 <span class="field-required">*</span>
            </label>
            <div class="input-group">
                <span class="input-icon">
                    <i class="bi bi-lock"></i>
                </span>
                <input type="password" class="form-control input-with-icon" id="password" name="password"
                       placeholder="请输入6-16位密码" required>
            </div>
            <div class="strength-meter">
                <div class="strength-bar" id="passwordStrength"></div>
            </div>
            <div class="text-danger error-msg" id="passwordError"></div>
            <div class="password-hint">
                密码必须包含：字母、数字、特殊字符（@#$%^&*）
            </div>
        </div>

        <div class="form-group mb-4">
            <label for="confirmPwd" class="form-label">
                确认密码 <span class="field-required">*</span>
            </label>
            <div class="input-group">
                <span class="input-icon">
                    <i class="bi bi-lock-fill"></i>
                </span>
                <input type="password" class="form-control input-with-icon" id="confirmPwd"
                       placeholder="请再次输入密码" required>
            </div>
            <div class="text-danger error-msg" id="confirmPwdError"></div>
        </div>

        <div class="form-group mb-4">
            <label for="phone" class="form-label">
                手机号 <span class="text-muted">（选填）</span>
            </label>
            <div class="input-group">
                <span class="input-icon">
                    <i class="bi bi-phone"></i>
                </span>
                <input type="tel" class="form-control input-with-icon" id="phone" name="phonenumber"
                       placeholder="请输入11位手机号">
            </div>
            <div class="text-danger error-msg" id="phoneError"></div>
            <div class="password-hint">用于订单通知和密码找回</div>
        </div>

        <div class="alert alert-danger" id="errorMsg" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i>
            <span id="errorText"></span>
        </div>

        <div class="alert alert-success" id="successMsg" style="display: none;">
            <i class="bi bi-check-circle"></i>
            <span id="successText"></span>
        </div>

        <button type="submit" class="btn btn-register w-100" id="submitBtn">
            <span class="loading-spinner" id="loadingSpinner"></span>
            <span id="submitText">完成注册</span>
        </button>

        <div class="login-link">
            <span>已有账号？</span>
            <a href="login.html" class="text-primary">立即登录</a>
        </div>
    </form>
</div>

<script>
    $(function() {
        // 添加图标字体
        $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">');

        // 密码强度检测
        function checkPasswordStrength(password) {
            let strength = 0;
            const $strengthBar = $("#passwordStrength");

            if (password.length >= 6) strength++;
            if (/[a-z]/.test(password) || /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[@#$%^&*]/.test(password)) strength++;

            // 更新强度条
            $strengthBar.removeClass("strength-weak strength-medium strength-strong");

            if (password.length === 0) {
                $strengthBar.css("width", "0");
            } else if (strength <= 2) {
                $strengthBar.addClass("strength-weak").css("width", "33%");
            } else if (strength === 3) {
                $strengthBar.addClass("strength-medium").css("width", "66%");
            } else {
                $strengthBar.addClass("strength-strong").css("width", "100%");
            }
        }

        // 表单验证
        function validateForm() {
            let isValid = true;

            // 获取并清洗字段
            const loginName = $("#loginName").val().trim();
            const password = $("#password").val().trim();
            const confirmPwd = $("#confirmPwd").val().trim();
            const phone = $("#phone").val().trim();

            // 清空之前的错误信息
            $(".error-msg").text("").hide();
            $("#errorMsg").hide();

            // 验证账号
            if (!loginName) {
                $("#loginNameError").text("登录账号不能为空").show();
                isValid = false;
            } else if (loginName.length < 2 || loginName.length > 16) {
                $("#loginNameError").text("账号长度需在2-16位之间").show();
                isValid = false;
            } else if (!/^[a-zA-Z0-9_]+$/.test(loginName)) {
                $("#loginNameError").text("账号只能包含字母、数字和下划线").show();
                isValid = false;
            }

            // 验证密码
            if (!password) {
                $("#passwordError").text("密码不能为空").show();
                isValid = false;
            } else if (password.length < 6 || password.length > 16) {
                $("#passwordError").text("密码长度需在6-16位之间").show();
                isValid = false;
            } else {
                // 密码格式校验（与后端一致）
                const pwdReg = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[@#$%^&*])[a-zA-Z\d@#$%^&*]{6,16}$/;
                if (!pwdReg.test(password)) {
                    $("#passwordError").text("密码必须包含字母、数字和特殊字符（@#$%^&*）").show();
                    isValid = false;
                }
            }

            // 验证确认密码
            if (!confirmPwd) {
                $("#confirmPwdError").text("请确认密码").show();
                isValid = false;
            } else if (password !== confirmPwd) {
                $("#confirmPwdError").text("两次输入的密码不一致").show();
                isValid = false;
            }

            // 验证手机号（可选）
            if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
                $("#phoneError").text("请输入正确的手机号").show();
                isValid = false;
            }

            return {isValid, loginName, password, phone};
        }

        // 显示加载状态
        function showLoading() {
            $("#loadingSpinner").show();
            $("#submitText").text("注册中...");
            $("#submitBtn").prop("disabled", true);
        }

        // 隐藏加载状态
        function hideLoading() {
            $("#loadingSpinner").hide();
            $("#submitText").text("完成注册");
            $("#submitBtn").prop("disabled", false);
        }

        // 显示错误信息
        function showError(message) {
            $("#errorText").text(message);
            $("#errorMsg").show();
            // 自动隐藏错误信息
            setTimeout(() => {
                $("#errorMsg").hide();
            }, 5000);
        }

        // 显示成功信息
        function showSuccess(message) {
            $("#successText").text(message);
            $("#successMsg").show();
        }

        // 隐藏成功信息
        function hideSuccess() {
            $("#successMsg").hide();
        }

        // 密码强度实时检测
        $("#password").on("input", function() {
            const password = $(this).val().trim();
            checkPasswordStrength(password);
            $("#passwordError").text("").hide();
        });

        // 表单提交事件
        $("#registerForm").submit(function(e) {
            e.preventDefault();

            // 验证表单
            const {isValid, loginName, password, phone} = validateForm();
            if (!isValid) {
                return;
            }

            // 显示加载状态
            showLoading();

            // 构造请求数据
            const data = {
                loginName: loginName,
                password: password,
                phonenumber: phone || ""  // 确保空值也传递
            };

            console.log("发送注册请求:", data); // 调试用

            // 调用后端注册接口
            $.ajax({
                url: "/user/register",
                type: "POST",
                data: data,
                dataType: "json",
                timeout: 10000, // 10秒超时
                success: function(res) {
                    hideLoading();
                    console.log("注册响应:", res); // 调试用

                    if (res.code === 200) {
                        // 注册成功
                        showSuccess("注册成功！3秒后跳转到登录页...");

                        // 清除表单
                        $("#registerForm")[0].reset();
                        $("#passwordStrength").css("width", "0");

                        // 延迟跳转到登录页
                        setTimeout(() => {
                            window.location.href = "login.html";
                        }, 3000);
                    } else {
                        // 注册失败：显示错误信息
                        showError(res.msg || "注册失败，请重试");
                    }
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    console.error("注册请求失败:", status, error);

                    if (status === "timeout") {
                        showError("请求超时，请检查网络连接");
                    } else if (xhr.status === 0) {
                        showError("无法连接服务器，请检查网络");
                    } else if (xhr.status === 404) {
                        showError("注册接口不存在，请联系管理员");
                    } else if (xhr.status >= 500) {
                        showError("服务器内部错误，请稍后重试");
                    } else {
                        showError("注册失败：" + (error || "未知错误"));
                    }
                }
            });
        });

        // 输入框实时验证
        $("input").on("input", function() {
            const $this = $(this);
            const id = $this.attr("id");

            // 清空对应错误信息
            if (id === "loginName") {
                $("#loginNameError").text("").hide();
            } else if (id === "password") {
                // 密码已单独处理
            } else if (id === "confirmPwd") {
                $("#confirmPwdError").text("").hide();
            } else if (id === "phone") {
                $("#phoneError").text("").hide();
            }

            // 如果之前有全局错误信息，也隐藏
            $("#errorMsg").hide();
            hideSuccess();
        });

        // 页面加载时检查是否已登录
        $(document).ready(function() {
            const userInfo = JSON.parse(sessionStorage.getItem("USER_INFO"));
            if (userInfo && userInfo.user_id) {
                // 如果已登录，显示提示并跳转
                showSuccess("您已登录，正在跳转到首页...");
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 2000);
            }
        });
    });
</script>
</body>
</html>