<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>登录 - 在线图书销售系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <style>
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-header h3 {
            color: #0d6efd;
            font-weight: 600;
        }
        .form-control:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .btn-login {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            border: none;
            font-weight: 500;
            padding: 10px;
            transition: all 0.3s ease;
        }
        .btn-login:hover {
            background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
        }
        .btn-login:active {
            transform: translateY(0);
        }
        .register-link {
            text-align: center;
            margin-top: 20px;
            color: #6c757d;
        }
        .register-link a {
            color: #0d6efd;
            text-decoration: none;
            font-weight: 500;
        }
        .register-link a:hover {
            text-decoration: underline;
        }
        .error-msg {
            font-size: 0.9em;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 5px;
            display: none;
        }
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .nav-link {
            color: #fff;
        }
        .nav-link:hover {
            color: #e9ecef;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .input-group {
            position: relative;
        }
        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 3;
        }
        .input-with-icon {
            padding-left: 40px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <i class="bi bi-book-half"></i> 在线图书销售系统
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="login.html">登录</a>
                </li>
            </ul>
            <div class="navbar-nav">
                <a class="nav-link" href="register.html">注册</a>
            </div>
        </div>
    </div>
</nav>

<div class="login-container">
    <div class="login-header">
        <h3>用户登录</h3>
        <p class="text-muted">请输入您的账号和密码</p>
    </div>

    <form id="loginForm">
        <div class="form-group">
            <label for="loginName" class="form-label">账号</label>
            <div class="input-group">
                <span class="input-icon">
                    <i class="bi bi-person"></i>
                </span>
                <input type="text" class="form-control input-with-icon" id="loginName" name="loginName"
                       placeholder="请输入账号" required>
            </div>
            <div class="text-danger error-msg" id="loginNameError"></div>
        </div>

        <div class="form-group">
            <label for="password" class="form-label">密码</label>
            <div class="input-group">
                <span class="input-icon">
                    <i class="bi bi-lock"></i>
                </span>
                <input type="password" class="form-control input-with-icon" id="password" name="password"
                       placeholder="请输入密码" required>
            </div>
            <div class="text-danger error-msg" id="passwordError"></div>
        </div>

        <div class="alert alert-danger" id="errorMsg" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i>
            <span id="errorText"></span>
        </div>

        <button type="submit" class="btn btn-login w-100" id="submitBtn">
            <span class="loading-spinner" id="loadingSpinner"></span>
            <span id="submitText">登录</span>
        </button>

        <div class="register-link">
            还没有账号？<a href="register.html">去注册</a>
        </div>
    </form>
</div>

<script>
    $(function() {
        // 添加图标字体
        $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">');

        // 表单验证
        function validateForm() {
            let isValid = true;

            // 获取并清洗字段
            const loginName = $("#loginName").val().trim();
            const password = $("#password").val().trim();

            // 清空之前的错误信息
            $(".error-msg").text("").hide();
            $("#errorMsg").hide();

            // 验证账号
            if (!loginName) {
                $("#loginNameError").text("账号不能为空").show();
                isValid = false;
            } else if (loginName.length < 2 || loginName.length > 16) {
                $("#loginNameError").text("账号长度需在2-16位之间").show();
                isValid = false;
            }

            // 验证密码
            if (!password) {
                $("#passwordError").text("密码不能为空").show();
                isValid = false;
            } else if (password.length < 6 || password.length > 16) {
                $("#passwordError").text("密码长度需在6-16位之间").show();
                isValid = false;
            } else {
                // 密码格式校验（与后端一致）
                const pwdReg = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[@#$%^&*])[a-zA-Z\d@#$%^&*]{6,16}$/;
                if (!pwdReg.test(password)) {
                    $("#passwordError").text("密码必须包含字母、数字、特殊字符（@#$%^&*）").show();
                    isValid = false;
                }
            }

            return {isValid, loginName, password};
        }

        // 显示加载状态
        function showLoading() {
            $("#loadingSpinner").show();
            $("#submitText").text("登录中...");
            $("#submitBtn").prop("disabled", true);
        }

        // 隐藏加载状态
        function hideLoading() {
            $("#loadingSpinner").hide();
            $("#submitText").text("登录");
            $("#submitBtn").prop("disabled", false);
        }

        // 显示错误信息
        function showError(message) {
            $("#errorText").text(message);
            $("#errorMsg").show();
            // 自动隐藏错误信息
            setTimeout(() => {
                $("#errorMsg").hide();
            }, 5000);
        }

        // 表单提交事件
        $("#loginForm").submit(function(e) {
            e.preventDefault();

            // 验证表单
            const {isValid, loginName, password} = validateForm();
            if (!isValid) {
                return;
            }

            // 显示加载状态
            showLoading();

            // 构造请求数据
            const data = {
                loginName: loginName,
                password: password
            };

            console.log("发送登录请求:", data); // 调试用

            // 调用后端登录接口
            $.ajax({
                url: "/user/login",
                type: "POST",
                data: data,
                dataType: "json",
                timeout: 10000, // 10秒超时
                success: function(res) {
                    hideLoading();
                    console.log("登录响应:", res); // 调试用

                    if (res.code === 200) {
                        // 登录成功：存储用户信息到SessionStorage
                        const userInfo = res.data.userInfo || res.data;
                        sessionStorage.setItem("USER_INFO", JSON.stringify(userInfo));

                        // 显示成功消息
                        showSuccess("登录成功，正在跳转...");

                        // 延迟跳转到首页
                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 1500);
                    } else {
                        // 登录失败：显示错误
                        showError(res.msg || "登录失败，请检查账号和密码");
                    }
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    console.error("登录请求失败:", status, error);

                    if (status === "timeout") {
                        showError("请求超时，请检查网络连接");
                    } else if (xhr.status === 0) {
                        showError("无法连接服务器，请检查网络");
                    } else if (xhr.status === 404) {
                        showError("登录接口不存在，请联系管理员");
                    } else if (xhr.status >= 500) {
                        showError("服务器内部错误，请稍后重试");
                    } else {
                        showError("登录失败：" + (error || "未知错误"));
                    }
                }
            });
        });

        // 显示成功信息（临时函数）
        function showSuccess(message) {
            $("#errorMsg").removeClass("alert-danger").addClass("alert-success");
            $("#errorText").html('<i class="bi bi-check-circle"></i> ' + message);
            $("#errorMsg").show();
        }

        // 输入框实时验证
        $("#loginName, #password").on("input", function() {
            const $this = $(this);
            const id = $this.attr("id");

            // 清空对应错误信息
            if (id === "loginName") {
                $("#loginNameError").text("").hide();
            } else if (id === "password") {
                $("#passwordError").text("").hide();
            }

            // 如果之前有全局错误信息，也隐藏
            $("#errorMsg").hide();
        });

        // 页面加载时检查是否已登录
        $(document).ready(function() {
            const userInfo = JSON.parse(sessionStorage.getItem("USER_INFO"));
            if (userInfo && userInfo.user_id) {
                // 如果已登录，显示提示并跳转
                showSuccess("您已登录，正在跳转到首页...");
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 2000);
            }
        });
    });
</script>
</body>
</html>