<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>订单详情 - 在线图书销售系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .detail-container { margin-top: 30px; }
        .detail-card { box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 20px; }
        .card-header { background: #f8f9fa; border-bottom: 1px solid #eee; }
        .order-item-table { width: 100%; margin-top: 15px; }
        .order-item-table th, .order-item-table td { text-align: center; padding: 10px; border-bottom: 1px solid #eee; }
        .order-item-table th { background: #f8f9fa; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <i class="bi bi-book-half"></i> 在线图书销售系统
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                <li class="nav-item"><a class="nav-link" href="orderList.html">我的订单</a></li>
                <li class="nav-item"><a class="nav-link active" href="orderDetail.html">订单详情</a></li>
            </ul>
            <ul class="navbar-nav" id="userMenu">
                <li class="nav-item dropdown" id="loginMenu" style="display: none;">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> <span id="loginUserName"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="myCenter.html">个人中心</a></li>
                        <li><a class="dropdown-item" href="cart.html">购物车</a></li>
                        <li><a class="dropdown-item text-danger" href="javascript:;" id="logoutBtn">退出登录</a></li>
                    </ul>
                </li>
                <li class="nav-item" id="notLoginMenu"><a class="nav-link" href="login.html">登录</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container detail-container">
    <a href="orderList.html" class="btn btn-outline-primary mb-3">
        <i class="bi bi-arrow-left"></i> 返回订单列表
    </a>

    <div class="card detail-card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-file-text"></i> 订单基本信息</h5>
        </div>
        <div class="card-body" id="orderBaseInfo">
            <div class="text-center text-muted">加载中...</div>
        </div>
    </div>

    <div class="card detail-card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-check"></i> 订单图书明细</h5>
        </div>
        <div class="card-body" id="orderItemContainer">
            <div class="text-center text-muted">加载中...</div>
        </div>
    </div>
</div>

<script>
    $(function() {
        // 1. 检查登录状态
        const userInfo = JSON.parse(sessionStorage.getItem("USER_INFO"));
        if (!userInfo || !userInfo.login_name) {
            window.location.href = "login.html";
            return;
        }
        $("#notLoginMenu").hide();
        $("#loginMenu").show();
        $("#loginUserName").text(userInfo.login_name || userInfo.loginName);

        // 2. 获取 URL 中的 orderId 参数
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get("orderId");
        if (!orderId || orderId <= 0) {
            alert("订单ID无效，跳回订单列表");
            window.location.href = "orderList.html";
            return;
        }

        // 3. 加载订单详情
        loadOrderDetail(orderId);

        // 4. 退出登录
        $("#logoutBtn").click(function() {
            sessionStorage.removeItem("USER_INFO");
            localStorage.removeItem("USER_CART");
            window.location.href = "index.html";
        });
    });

    // 加载订单详情
    // 在 loadOrderDetail() 函数中修复字段映射
    // 在 loadOrderDetail() 函数中修复字段映射
    function loadOrderDetail(orderId) {
        $.get("/user/getMyOrderDetail?orderId=" + orderId, function(res) {
            const $baseInfo = $("#orderBaseInfo");
            const $itemContainer = $("#orderItemContainer");

            if (res.code !== 200 || !res.data || res.data.length === 0) {
                $baseInfo.html(`<div class="text-danger text-center">${res.msg || "未查询到订单详情"}</div>`);
                $itemContainer.html(`<div class="text-danger text-center">无订单项数据</div>`);
                return;
            }

            // 订单项数据
            const orderItems = res.data;
            const firstItem = orderItems[0];
            const totalAmount = calculateTotalAmount(orderItems);

            // 渲染订单基本信息
            $baseInfo.html(`
            <div class="row g-3">
                <div class="col-md-3">
                    <span class="fw-bold">订单编号：</span>
                    <span>${firstItem.order_id || firstItem.orderId || "未知"}</span>
                </div>
                <div class="col-md-3">
                    <span class="fw-bold">用户ID：</span>
                    <span>${firstItem.user_id || firstItem.userId || "未知"}</span>
                </div>
                <div class="col-md-3">
                    <span class="fw-bold">订单总金额：</span>
                    <span class="text-danger">¥${totalAmount}</span>
                </div>
                <div class="col-md-3">
                    <span class="fw-bold">订单项数：</span>
                    <span>${orderItems.length} 件</span>
                </div>
            </div>
        `);

            // 渲染订单项表格
            let itemHtml = `
            <table class="order-item-table">
                <thead>
                    <tr>
                        <th>图书ID</th>
                        <th>图书名称</th>
                        <th>作者</th>
                        <th>购买数量</th>
                        <th>图书单价</th>
                        <th>小计</th>
                    </tr>
                </thead>
                <tbody>
        `;
            orderItems.forEach(item => {
                const bookPrice = item.bookPrice || item.price || 0;
                const num = item.num || 0;
                const itemTotal = (bookPrice * num).toFixed(2);
                itemHtml += `
                <tr>
                    <td>${item.bid || item.bookId || "未知"}</td>
                    <td>${item.book_name || item.bookName || "未知"}</td>
                    <td>${item.bookAuthor || item.author || "未知"}</td>
                    <td>${num}</td>
                    <td>¥${bookPrice}</td>
                    <td>¥${itemTotal}</td>
                </tr>
            `;
            });
            itemHtml += `
                </tbody>
            </table>
        `;
            $itemContainer.html(itemHtml);
        }).fail(function() {
            alert("加载订单详情失败，请检查后端服务");
        });
    }

    // 计算订单总金额
    function calculateTotalAmount(orderItems) {
        let total = 0;
        orderItems.forEach(item => {
            total += (item.bookPrice || 0) * (item.num || 0);
        });
        return total.toFixed(2);
    }
</script>
</body>
</html>