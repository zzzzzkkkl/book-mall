<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>热销榜 - 在线图书销售系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <style>
        /* 添加顶部内边距，防止内容被固定导航栏遮挡 */
        body {
            padding-top: 56px;
            background-color: #f8f9fa;
        }

        /* 样式部分保持不变 */
        .hotbooks-container { margin-top: 30px; }
        .hotbooks-title { margin-bottom: 30px; text-align: center; color: #dc3545; }
        .hotbook-item { margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; transition: all 0.3s; background: #fff; }
        .hotbook-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .rank-badge { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 18px; color: white; }
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ff9500 100%); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #a0a0a0 100%); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #a6692e 100%); }
        .rank-other { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
        .book-cover { width: 100px; height: 140px; object-fit: contain; border-radius: 4px; }
        .sale-num-highlight { color: #dc3545; font-weight: bold; font-size: 1.1em; }
        .stock-status { padding: 3px 8px; border-radius: 4px; font-size: 0.9em; }
        .in-stock { background-color: #d4edda; color: #155724; }
        .out-stock { background-color: #f8d7da; color: #721c24; }
        .off-shelf { background-color: #e2e3e5; color: #383d41; }
        .subtitle { color: #6c757d; margin-bottom: 30px; }

        /* 添加滚动阴影效果 */
        .navbar.fixed-top {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
        }
        /* 滚动时加深阴影 */
        .scrolled .navbar.fixed-top {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <i class="bi bi-book-half"></i> 在线图书销售系统
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                <li class="nav-item"><a class="nav-link active" href="hotBooks.html">热销榜</a></li>
                <li class="nav-item"><a class="nav-link" href="myCenter.html">个人中心</a></li>
            </ul>
            <div class="navbar-nav" id="userNavArea">
                <a class="nav-link" href="login.html" id="toLoginBtn">登录</a>
                <a class="nav-link" href="register.html" id="toRegisterBtn">注册</a>
                <div class="nav-item dropdown" id="userDropdown" style="display: none;">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> <span id="loginUserName"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="myCenter.html">个人中心</a></li>
                        <li><a class="dropdown-item" href="cart.html"><i class="bi bi-cart"></i> 购物车</a></li>
                        <li><a class="dropdown-item" href="orderList.html">我的订单</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="javascript:;" id="logoutBtn">退出登录</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="container hotbooks-container">
    <div class="hotbooks-title">
        <h2><i class="bi bi-trophy-fill"></i> 热销图书排行榜 TOP 10</h2>
        <p class="subtitle">根据图书销量排序（展示销量前10的图书）</p>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div id="hotBooksList" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">加载热销榜数据中...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(function() {
        initLoginStatus();
        loadHotBooksList();

        // 监听滚动，添加阴影类
        $(window).scroll(function() {
            if ($(window).scrollTop() > 10) {
                $('nav').addClass('scrolled');
            } else {
                $('nav').removeClass('scrolled');
            }
        });

        $("#logoutBtn").click(function() {
            sessionStorage.removeItem("USER_INFO");
            location.reload();
        });
    });

    function initLoginStatus() {
        const userInfo = JSON.parse(sessionStorage.getItem("USER_INFO"));
        if (userInfo) {
            $("#toLoginBtn, #toRegisterBtn").hide();
            $("#userDropdown").show();
            $("#loginUserName").text(userInfo.login_name || userInfo.loginName);
        }
    }

    function loadHotBooksList() {
        console.log("开始加载热销榜数据，请求接口：/user/getAllHotBooks");

        $.ajax({
            url: "/user/getHotBooks",
            type: "GET",
            success: function(res) {
                console.log("热销榜响应数据:", res);

                if (res.code === 200 && res.data) {
                    let listHtml = "";
                    const hotBooks = res.data;

                    if (hotBooks.length === 0) {
                        listHtml = `<div class="alert alert-info">暂无热销图书数据</div>`;
                    } else {
                        hotBooks.forEach((book, index) => {
                            const rank = index + 1;

                            // 处理字段映射
                            const bookId = book.bid || book.bookId || book.book_id;
                            const bookName = book.book_name || book.bookName;
                            const author = book.author || "未知作者";
                            const price = book.price || 0;
                            const saleNum = book.sale_num || book.saleNum || 0;
                            const bookType = book.book_type || book.bookType || "未分类";

                            // 获取封面URL，如果有则使用，否则使用默认图片
                            const coverUrl = book.cover_url || book.coverUrl;
                            const coverImgSrc = coverUrl && coverUrl.trim() !== '' ?
                                coverUrl :
                                `https://picsum.photos/id/${(bookId % 50) + 1}/100/140`;

                            // 库存字段处理
                            let stockNum = 0;
                            if (book.stock_num !== undefined) stockNum = book.stock_num;
                            else if (book.stockNum !== undefined) stockNum = book.stockNum;

                            let rankClass = "rank-other";
                            if (rank === 1) rankClass = "rank-1";
                            else if (rank === 2) rankClass = "rank-2";
                            else if (rank === 3) rankClass = "rank-3";

                            let stockClass = "in-stock";
                            let stockText = "有货";
                            if (stockNum === -1) {
                                stockClass = "off-shelf";
                                stockText = "已下架";
                            }
                            else if (stockNum === 0) {
                                stockClass = "out-stock";
                                stockText = "无货";
                            }

                            listHtml += `
                            <div class="hotbook-item">
                                <div class="row align-items-center">
                                    <div class="col-md-1 text-center">
                                        <div class="rank-badge ${rankClass} mx-auto">${rank}</div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <img src="${coverImgSrc}"
                                             alt="${bookName}" class="book-cover">
                                    </div>
                                    <div class="col-md-5">
                                        <h5 class="mb-2">${bookName}</h5>
                                        <p class="mb-1"><i class="bi bi-person"></i> ${author}</p>
                                        <p class="mb-1"><i class="bi bi-tag"></i> ${bookType}</p>
                                        <p class="mb-0">
                                            <span class="stock-status ${stockClass}">${stockText}</span>
                                            ${stockNum > 0 ? `<span class="ms-2">库存：${stockNum}本</span>` : ''}
                                        </p>
                                    </div>
                                    <div class="col-md-2">
                                        <p class="mb-1"><strong>价格：</strong><span class="text-primary">¥${price}</span></p>
                                        <p class="mb-0 sale-num-highlight">
                                            <i class="bi bi-graph-up"></i> 销量：${saleNum}本
                                        </p>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <a href="bookDetail.html?bookId=${bookId}" class="btn btn-primary btn-sm">
                                            <i class="bi bi-eye"></i> 查看详情
                                        </a>
                                        ${stockNum > 0 ? `
                                            <button class="btn btn-success btn-sm mt-2 add-to-cart"
                                                    data-bookid="${bookId}" data-bookname="${bookName}"
                                                    data-price="${price}" data-stock="${stockNum}">
                                                <i class="bi bi-cart-plus"></i> 加入购物车
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        });
                    }
                    $("#hotBooksList").html(listHtml);
                    bindAddToCart();
                } else {
                    console.error("获取热销榜数据失败，响应码:", res.code, "消息:", res.msg);
                    $("#hotBooksList").html(`
                    <div class="alert alert-warning">
                        <h5>获取数据失败</h5>
                        <p>错误代码: ${res.code || "未知"}</p>
                        <p>错误信息: ${res.msg || "未知错误"}</p>
                    </div>
                `);
                }
            },
            error: function(xhr, status, error) {
                console.error("热销榜请求错误:", {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    readyState: xhr.readyState,
                    responseText: xhr.responseText,
                    error: error
                });

                let errorHtml = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> 无法连接服务器</h5>
                    <p>请检查以下问题：</p>
                    <ul>
                        <li>后端服务是否启动（Spring Boot应用）</li>
                        <li>网络连接是否正常</li>
                        <li>端口号是否正确（默认8080）</li>
                        <li>数据库连接是否正常</li>
                    </ul>
                    <hr>
                    <p class="mb-1"><strong>调试信息：</strong></p>
                    <p class="mb-1">请求状态: ${xhr.status} ${status}</p>
                    <p class="mb-0">错误信息: ${error || "未知错误"}</p>
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> 重新加载
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="window.location.href='index.html'">
                        <i class="bi bi-house"></i> 返回首页
                    </button>
                </div>
            `;

                $("#hotBooksList").html(errorHtml);
            }
        });
    }

    function bindAddToCart() {
        $(".add-to-cart").off("click").click(function() {
            const userInfo = JSON.parse(sessionStorage.getItem("USER_INFO"));
            if (!userInfo) {
                alert("请先登录再加入购物车");
                window.location.href = "login.html";
                return;
            }

            const $bookItem = $(this).closest(".hotbook-item");
            const book = {
                bookId: parseInt($(this).data("bookid")),
                bookName: $(this).data("bookname"),
                price: parseFloat($(this).data("price")),
                stock: $(this).data("stock"),
                num: 1,
                coverUrl: $bookItem.find("img.book-cover").attr("src")  // 新增这行
            };

            let cart = JSON.parse(localStorage.getItem("USER_CART")) || [];
            const existIndex = cart.findIndex(item => item.bookId === book.bookId);
            if (existIndex > -1) {
                cart[existIndex].num += 1;
            } else {
                cart.push(book);
            }
            localStorage.setItem("USER_CART", JSON.stringify(cart));
            alert(`《${book.bookName}》已加入购物车`);
        });
    }
</script>
</body>
</html>