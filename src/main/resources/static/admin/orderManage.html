<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>订单管理 - 管理员端</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#">在线图书销售系统</a>
        <div class="navbar-nav">
            <a class="nav-link" href="/admin/bookManage.html">图书管理</a>
            <a class="nav-link" href="/admin/userManage.html">用户管理</a>
            <a class="nav-link active" href="/admin/orderManage.html">订单管理</a>
            <a class="nav-link" href="/admin/saleStat.html">销售榜</a>
        </div>
        <div class="navbar-nav ms-auto">
            <span class="nav-link text-white" id="adminName">管理员</span>
            <button class="btn btn-light ms-2" id="logoutBtn">退出登录</button>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-light py-3">
            <h5 class="mb-0">所有订单列表</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                    <tr>
                        <th>订单ID</th>
                        <th>用户ID</th>
                        <th>订单金额</th>
                        <th>订单状态</th>
                        <th>下单时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="orderTableBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted py-3">加载中...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 订单详情模态框 -->
<div class="modal fade" id="orderItemModal" tabindex="-1" aria-labelledby="orderItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="orderItemModalLabel">订单详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th>详情ID</th>
                        <th>订单ID</th>
                        <th>图书ID</th>
                        <th>图书名称</th>
                        <th>购买数量</th>
                    </tr>
                    </thead>
                    <tbody id="orderItemTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(function() {
        // 检查登录状态
        checkLoginStatus();

        // 退出登录
        $("#logoutBtn").click(() => window.location.href = "/admin/login.html");

        // 加载订单列表
        function loadOrderList() {
            $.get("/admin/order/list", function(orders) {
                let html = "";
                if (orders && orders.length > 0) {
                    // 匹配Order实体状态（0-删除，1-待支付，2-已完成）
                    const statusMap = {
                        0: "已删除",
                        1: "待支付",
                        2: "已完成"
                    };

                    orders.forEach(order => {
                        // 时间格式化
                        let saleTime = "-";
                        if (order.saleTime) {
                            try {
                                saleTime = new Date(order.saleTime).toLocaleString('zh-CN');
                            } catch (e) {
                                saleTime = order.saleTime;
                            }
                        }

                        // 金额格式化
                        const amount = order.salePrice || 0;
                        const amountFormatted = parseFloat(amount).toFixed(2);

                        // 状态
                        const state = order.state || 0;
                        const statusText = statusMap[state] || "未知";

                        html += `
                            <tr>
                                <td>${order.orderId || '-'}</td>
                                <td>${order.userId || '-'}</td>
                                <td>¥${amountFormatted}</td>
                                <td>${statusText}</td>
                                <td>${saleTime}</td>
                                <td>
                                    <button class="btn btn-info btn-sm view-order-item" data-orderid="${order.orderId}">
                                        查看详情
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    html = `<tr><td colspan="6" class="text-center text-muted py-3">暂无订单数据</td></tr>`;
                }
                $("#orderTableBody").html(html);
            }).fail(() => {
                $("#orderTableBody").html(`<tr><td colspan="6" class="text-center text-danger py-3">加载失败，请刷新页面</td></tr>`);
            });
        }

        // 查看订单详情【核心修改：匹配OrderItem实体的num字段，优化接口调用逻辑】
        $(document).on("click", ".view-order-item", function() {
            const orderId = $(this).data("orderid");
            // 优化：优先调用带orderId参数的后端接口（减少前端过滤，提升性能）
            $.get("/admin/order/item/list?orderId=" + orderId, function(items) {
                let html = "";
                if (items && items.length > 0) {
                    items.forEach(item => {
                        // 核心修正1：购买数量用item.num（匹配OrderItem实体字段）
                        // 核心修正2：兼容字段名的驼峰/下划线（book_id → bookId）
                        const detailId = item.id || item.detailId || '-';
                        const bookId = item.bookId || item.book_id || '-';
                        const bookName = item.bookName || item.book_name || '-';
                        const buyNum = item.num || 0; // 关键：替换原quantity为num

                        html += `
                            <tr>
                                <td>${detailId}</td>
                                <td>${orderId}</td>
                                <td>${bookId}</td>
                                <td>${bookName}</td>
                                <td>${buyNum}</td>
                            </tr>
                        `;
                    });
                } else {
                    html = `<tr><td colspan="5" class="text-center text-muted py-3">暂无该订单的详情数据</td></tr>`;
                }
                $("#orderItemTableBody").html(html);
                $("#orderItemModal").modal("show");
            }).fail((xhr) => {
                // 降级方案：若后端未实现带orderId的接口，仍用全量数据前端过滤
                $.get("/admin/order/item/list", function(allItems) {
                    const items = allItems.filter(item => (item.orderId || item.order_id) == orderId);
                    let html = "";
                    if (items && items.length > 0) {
                        items.forEach(item => {
                            const detailId = item.id || item.detailId || '-';
                            const bookId = item.bookId || item.book_id || '-';
                            const bookName = item.bookName || item.book_name || '-';
                            const buyNum = item.num || 0;

                            html += `
                                <tr>
                                    <td>${detailId}</td>
                                    <td>${orderId}</td>
                                    <td>${bookId}</td>
                                    <td>${bookName}</td>
                                    <td>${buyNum}</td>
                                </tr>
                            `;
                        });
                    } else {
                        html = `<tr><td colspan="5" class="text-center text-muted py-3">暂无该订单的详情数据</td></tr>`;
                    }
                    $("#orderItemTableBody").html(html);
                    $("#orderItemModal").modal("show");
                }).fail(() => {
                    alert("查询详情失败：接口调用异常，请检查后端服务");
                });
            });
        });

        // 检查登录状态
        function checkLoginStatus() {
            $.get("/admin/checkLogin", function(res) {
                if (!res.success) {
                    window.location.href = "/admin/login.html";
                } else {
                    // 更新管理员名称
                    if (res.adminName) {
                        $("#adminName").text(res.adminName);
                    }
                    loadOrderList();
                }
            }).fail(() => {
                alert("登录状态检查失败");
                window.location.href = "/admin/login.html";
            });
        }
    });
</script>
</body>
</html>